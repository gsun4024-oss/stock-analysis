/**
 * 股票数据路由 — 服务端代理 Yahoo Finance API
 * 解决浏览器跨域问题，并提供 A 股中文名称映射
 */
import { z } from "zod";
import { publicProcedure, router } from "../_core/trpc";
import { TRPCError } from "@trpc/server";

// ============================================================
// A 股中文名称映射库（沪深主要股票）
// ============================================================
export const A_STOCK_NAMES: Record<string, string> = {
  // 沪市主板 - 白酒
  "600519.SS": "贵州茅台",
  "600809.SS": "山西汾酒",
  "600779.SS": "水井坊",
  "600559.SS": "老白干酒",
  // 沪市主板 - 银行
  "601398.SS": "工商银行",
  "601288.SS": "农业银行",
  "601939.SS": "建设银行",
  "601988.SS": "中国银行",
  "601328.SS": "交通银行",
  "600036.SS": "招商银行",
  "601166.SS": "兴业银行",
  "601998.SS": "中信银行",
  "601818.SS": "光大银行",
  "600016.SS": "民生银行",
  "600000.SS": "浦发银行",
  "601169.SS": "北京银行",
  "601009.SS": "南京银行",
  "601229.SS": "上海银行",
  "601577.SS": "长沙银行",
  "601838.SS": "成都银行",
  "601128.SS": "常熟银行",
  "601825.SS": "沪农商行",
  "601916.SS": "浙商银行",
  "601963.SS": "重庆银行",
  // 沪市主板 - 保险
  "601318.SS": "中国平安",
  "601628.SS": "中国人寿",
  "601601.SS": "中国太保",
  "601336.SS": "新华保险",
  "601319.SS": "中国人保",
  // 沪市主板 - 证券
  "600030.SS": "中信证券",
  "601688.SS": "华泰证券",
  "601211.SS": "国泰君安",
  "601881.SS": "中国银河",
  "601995.SS": "中金公司",
  "600837.SS": "海通证券",
  "601878.SS": "浙商证券",
  "601108.SS": "财通证券",
  "601198.SS": "东兴证券",
  "601555.SS": "东吴证券",
  "601375.SS": "中原证券",
  "601236.SS": "红塔证券",
  "601162.SS": "天风证券",
  "601189.SS": "银河证券",
  "601066.SS": "中信建投",
  "601456.SS": "国联证券",
  "601901.SS": "方正证券",
  "601990.SS": "南京证券",
  // 沪市主板 - 能源
  "601857.SS": "中国石油",
  "600028.SS": "中国石化",
  "600900.SS": "长江电力",
  "601088.SS": "中国神华",
  "601985.SS": "中国核电",
  "601728.SS": "中国电信",
  "600941.SS": "中国移动",
  "601225.SS": "陕西煤业",
  "601666.SS": "平煤股份",
  "601699.SS": "潞安环能",
  "601898.SS": "中煤能源",
  "600795.SS": "国电电力",
  "600886.SS": "国投电力",
  "601625.SS": "华电国际",
  "601991.SS": "大唐发电",
  "601727.SS": "上海电气",
  "600905.SS": "三峡能源",
  "601615.SS": "明阳智能",
  "601012.SS": "隆基绿能",
  "600438.SS": "通威股份",
  // 沪市主板 - 制造/汽车
  "600104.SS": "上汽集团",
  "601633.SS": "长城汽车",
  "601127.SS": "赛力斯",
  "601238.SS": "广汽集团",
  "600031.SS": "三一重工",
  "601100.SS": "恒立液压",
  "600309.SS": "万华化学",
  "600585.SS": "海螺水泥",
  "600690.SS": "海尔智家",
  "600887.SS": "伊利股份",
  "600276.SS": "恒瑞医药",
  "600196.SS": "复星医药",
  "600436.SS": "片仔癀",
  "600150.SS": "中国船舶",
  "600760.SS": "中航沈飞",
  "600893.SS": "航发动力",
  "600703.SS": "三安光电",
  "600745.SS": "闻泰科技",
  "600570.SS": "恒生电子",
  "600588.SS": "用友网络",
  "601138.SS": "工业富联",
  "600406.SS": "国电南瑞",
  "601766.SS": "中国中车",
  "601800.SS": "中国交建",
  "601668.SS": "中国建筑",
  "601669.SS": "中国电建",
  "601868.SS": "中国能建",
  "601390.SS": "中国中铁",
  "601186.SS": "中国铁建",
  "601600.SS": "中国铝业",
  "600362.SS": "江西铜业",
  "601899.SS": "紫金矿业",
  "601111.SS": "中国国航",
  "600029.SS": "南方航空",
  "601021.SS": "春秋航空",
  "601866.SS": "中远海发",
  "601919.SS": "中远海控",
  "601872.SS": "招商轮船",
  "600009.SS": "上海机场",
  "600004.SS": "白云机场",
  "601888.SS": "中国中免",
  "600048.SS": "保利发展",
  "600383.SS": "金地集团",
  "600606.SS": "绿地控股",
  "601155.SS": "新城控股",
  "600050.SS": "中国联通",
  "601698.SS": "中国卫通",
  "600816.SS": "安信信托",
  "601816.SS": "京沪高铁",
  "601006.SS": "大秦铁路",
  "600018.SS": "上港集团",
  "601717.SS": "中国中铁",
  "601776.SS": "中国广核",
  "600346.SS": "恒力石化",
  "600426.SS": "华鲁恒升",
  "600989.SS": "宝丰能源",
  "600547.SS": "山东黄金",
  "601958.SS": "金钼股份",
  // 深市主板 - 白酒/食品
  "000858.SZ": "五粮液",
  "000568.SZ": "泸州老窖",
  "000799.SZ": "酒鬼酒",
  "000869.SZ": "张裕A",
  "000895.SZ": "双汇发展",
  "000538.SZ": "云南白药",
  "000423.SZ": "东阿阿胶",
  "000999.SZ": "华润三九",
  "000513.SZ": "丽珠集团",
  "000963.SZ": "华东医药",
  "000650.SZ": "仁和药业",
  "000919.SZ": "金陵药业",
  // 深市主板 - 银行
  "000001.SZ": "平安银行",
  "000686.SZ": "东北证券",
  "000728.SZ": "国元证券",
  "000776.SZ": "广发证券",
  "000783.SZ": "长江证券",
  // 深市主板 - 制造/科技
  "000333.SZ": "美的集团",
  "000651.SZ": "格力电器",
  "000100.SZ": "TCL科技",
  "000725.SZ": "京东方A",
  "000002.SZ": "万科A",
  "000063.SZ": "中兴通讯",
  "000338.SZ": "潍柴动力",
  "000425.SZ": "徐工机械",
  "000528.SZ": "柳工",
  "000708.SZ": "中信特钢",
  "000709.SZ": "河钢股份",
  "000898.SZ": "鞍钢股份",
  "000825.SZ": "太钢不锈",
  "000630.SZ": "铜陵有色",
  "000878.SZ": "云南铜业",
  "000060.SZ": "中金岭南",
  "000762.SZ": "西藏矿业",
  "000792.SZ": "盐湖股份",
  "000629.SZ": "攀钢钒钛",
  "000625.SZ": "长安汽车",
  "000800.SZ": "一汽轿车",
  "000550.SZ": "江铃汽车",
  "000768.SZ": "中航西飞",
  "000738.SZ": "航发控制",
  "000733.SZ": "振华科技",
  "000977.SZ": "浪潮信息",
  "000938.SZ": "紫光股份",
  "000988.SZ": "华工科技",
  "000997.SZ": "新大陆",
  "000998.SZ": "隆平高科",
  "000876.SZ": "新希望",
  "000930.SZ": "中粮科技",
  "000902.SZ": "新洋丰",
  "000661.SZ": "长春高新",
  "000623.SZ": "吉林敖东",
  "000729.SZ": "燕京啤酒",
  "000860.SZ": "顺鑫农业",
  "000301.SZ": "东方盛虹",
  "000039.SZ": "中集集团",
  "000069.SZ": "华侨城A",
  "000581.SZ": "威孚高科",
  "000983.SZ": "山西焦煤",
  "000933.SZ": "神火股份",
  "000921.SZ": "海信家电",
  "000521.SZ": "美菱电器",
  "000541.SZ": "佛山照明",
  "000786.SZ": "北新建材",
  "000778.SZ": "新兴铸管",
  "000400.SZ": "许继电气",
  "000488.SZ": "晨鸣纸业",
  "000401.SZ": "冀东水泥",
  "000539.SZ": "粤电力A",
  "000883.SZ": "湖北能源",
  "000875.SZ": "吉电股份",
  "000958.SZ": "电投能源",
  "000966.SZ": "长源电力",
  "000543.SZ": "皖能电力",
  "000720.SZ": "新能泰山",
  "000591.SZ": "太阳能",
  "000732.SZ": "中国建筑",
  "002594.SZ": "比亚迪",
  "002415.SZ": "海康威视",
  "002475.SZ": "立讯精密",
  "002304.SZ": "洋河股份",
  "002352.SZ": "顺丰控股",
  "002049.SZ": "紫光国微",
  "002230.SZ": "科大讯飞",
  "002371.SZ": "北方华创",
  "002241.SZ": "歌尔股份",
  "002142.SZ": "宁波银行",
  "002001.SZ": "新和成",
  "002027.SZ": "分众传媒",
  "002044.SZ": "美年健康",
  "002050.SZ": "三花智控",
  "002120.SZ": "韵达股份",
  "002129.SZ": "中环股份",
  "002180.SZ": "纳思达",
  "002202.SZ": "金风科技",
  "002236.SZ": "大华股份",
  "002252.SZ": "上海莱士",
  "002271.SZ": "东方雨虹",
  "002311.SZ": "海大集团",
  "002340.SZ": "格林美",
  "002385.SZ": "大北农",
  "002410.SZ": "广联达",
  "002456.SZ": "欧菲光",
  "002460.SZ": "赣锋锂业",
  "002466.SZ": "天齐锂业",
  "002493.SZ": "荣盛石化",
  "002555.SZ": "三七互娱",
  "002601.SZ": "龙蟒佰利",
  "002624.SZ": "完美世界",
  "002648.SZ": "卫星化学",
  "002673.SZ": "西部证券",
  "002736.SZ": "国信证券",
  "002739.SZ": "万达电影",
  "002841.SZ": "视源股份",
  "002916.SZ": "深南电路",
  "002938.SZ": "鹏鼎控股",
  "002985.SZ": "北摩高科",
  "003816.SZ": "中国广核",
  // 创业板
  "300001.SZ": "特锐德",
  "300002.SZ": "神州泰岳",
  "300003.SZ": "乐普医疗",
  "300015.SZ": "爱尔眼科",
  "300033.SZ": "同花顺",
  "300059.SZ": "东方财富",
  "300122.SZ": "智飞生物",
  "300124.SZ": "汇川技术",
  "300142.SZ": "沃森生物",
  "300144.SZ": "宋城演艺",
  "300274.SZ": "阳光电源",
  "300316.SZ": "晶盛机电",
  "300347.SZ": "泰格医药",
  "300408.SZ": "三环集团",
  "300413.SZ": "芒果超媒",
  "300433.SZ": "蓝思科技",
  "300450.SZ": "先导智能",
  "300498.SZ": "温氏股份",
  "300529.SZ": "健帆生物",
  "300558.SZ": "贝达药业",
  "300595.SZ": "欧普康视",
  "300628.SZ": "亿联网络",
  "300661.SZ": "圣邦股份",
  "300676.SZ": "华大基因",
  "300699.SZ": "光威复材",
  "300750.SZ": "宁德时代",
  "300760.SZ": "迈瑞医疗",
  "300782.SZ": "卓胜微",
  "300785.SZ": "值得买",
  "300832.SZ": "新产业",
  "300896.SZ": "爱美客",
  "300999.SZ": "金龙鱼",
  // 科创板
  "688001.SS": "华兴源创",
  "688002.SS": "睿创微纳",
  "688003.SS": "天准科技",
  "688004.SS": "博汇股份",
  "688005.SS": "容百科技",
  "688006.SS": "杭可科技",
  "688007.SS": "光峰科技",
  "688008.SS": "澜起科技",
  "688009.SS": "中国通号",
  "688010.SS": "福光股份",
  "688012.SS": "中微公司",
  "688015.SS": "交控科技",
  "688016.SS": "心脉医疗",
  "688017.SS": "绿的谐波",
  "688018.SS": "乐鑫科技",
  "688019.SS": "安集科技",
  "688020.SS": "方邦股份",
  "688021.SS": "奥福环保",
  "688022.SS": "瀚川智能",
  "688023.SS": "安恒信息",
  "688024.SS": "天赐材料",
  "688025.SS": "杰普特",
  "688026.SS": "洁特生物",
  "688027.SS": "国盾量子",
  "688028.SS": "沃尔德",
  "688029.SS": "南微医学",
  "688030.SS": "山石网科",
  "688031.SS": "星环科技",
  "688032.SS": "禾迈股份",
  "688033.SS": "天宜上佳",
  "688036.SS": "传音控股",
  "688037.SS": "芯源微",
  "688038.SS": "中科通达",
  "688039.SS": "当虹科技",
  "688041.SS": "海光信息",
  "688042.SS": "龙软科技",
  "688043.SS": "云天励飞",
  "688045.SS": "必易微",
  "688046.SS": "药康生物",
  "688047.SS": "龙芯中科",
  "688048.SS": "长光华芯",
  "688049.SS": "炬芯科技",
  "688050.SS": "爱博医疗",
  "688051.SS": "佳华科技",
  "688052.SS": "纳芯微",
  "688053.SS": "思科瑞",
  "688054.SS": "通道股份",
  "688055.SS": "龙迅股份",
  "688056.SS": "莱特光电",
  "688057.SS": "金海通",
  "688058.SS": "奥普特",
  "688059.SS": "华锐精密",
  "688060.SS": "云涌科技",
  "688061.SS": "灿芯股份",
  "688062.SS": "迈威生物",
  "688063.SS": "派能科技",
  "688064.SS": "南网科技",
  "688065.SS": "凯赛生物",
  "688066.SS": "航天宏图",
  "688067.SS": "爱威科技",
  "688068.SS": "热景生物",
  "688069.SS": "德林海",
  "688070.SS": "纵横股份",
  "688071.SS": "华依科技",
  "688072.SS": "拓荆科技",
  "688073.SS": "毕得医药",
  "688074.SS": "盛美上海",
  "688075.SS": "安旭生物",
  "688076.SS": "诺泰生物",
  "688077.SS": "大地熊",
  "688078.SS": "龙版传媒",
  "688079.SS": "美迪西",
  "688080.SS": "映翰通",
  "688081.SS": "兴图新科",
  "688082.SS": "盛科通信",
  "688083.SS": "中望软件",
  "688084.SS": "晶品特装",
  "688085.SS": "三友医疗",
  "688086.SS": "科兴制药",
  "688087.SS": "英科再生",
  "688088.SS": "虹软科技",
  "688089.SS": "嘉必优",
  "688090.SS": "芯碁微装",
  "688091.SS": "上海谊众",
  "688092.SS": "爱科赛博",
  "688093.SS": "世华科技",
  "688094.SS": "科望医药",
  "688095.SS": "福昕软件",
  "688096.SS": "京源环保",
  "688097.SS": "博众精工",
  "688098.SS": "奥雅设计",
  "688099.SS": "晶晨股份",
  "688100.SS": "威胜信息",
  "688101.SS": "三达膜",
  "688102.SS": "斯瑞新材",
  "688103.SS": "国力股份",
  "688104.SS": "广大特材",
  "688105.SS": "诺唯赞",
  "688106.SS": "金宏气体",
  "688107.SS": "安路科技",
  "688108.SS": "赛诺医疗",
  "688109.SS": "山大地纬",
  "688110.SS": "东芯股份",
  "688111.SS": "金力永磁",
  "688112.SS": "鼎通科技",
  "688113.SS": "联特科技",
  "688114.SS": "华大智造",
  "688115.SS": "思林杰",
  "688116.SS": "天奈科技",
  "688117.SS": "汇宇制药",
  "688118.SS": "普元信息",
  "688119.SS": "江苏北人",
  "688120.SS": "华海清科",
  "688121.SS": "明志科技",
  "688122.SS": "西部超导",
  "688123.SS": "聚辰股份",
  "688124.SS": "通富微电",
  "688125.SS": "国力股份",
  "688126.SS": "沪硅产业",
  "688127.SS": "蓝特光学",
  "688128.SS": "中国电研",
  "688129.SS": "东来技术",
  "688130.SS": "芯动联科",
  "688131.SS": "皓元医药",
  "688132.SS": "传智教育",
  "688133.SS": "泰坦科技",
  "688134.SS": "通达海",
  "688135.SS": "利扬芯片",
  "688136.SS": "科信技术",
  "688137.SS": "近岸蛋白",
  "688138.SS": "清越科技",
  "688139.SS": "海正生材",
  "688140.SS": "以诺康",
  "688141.SS": "杰华特",
  "688142.SS": "航天软件",
  "688143.SS": "长盈通",
  "688144.SS": "振华风光",
  "688145.SS": "中芯国际",
  "688146.SS": "中船特气",
  "688147.SS": "微导纳米",
  "688148.SS": "芳源股份",
  "688149.SS": "东微半导",
  "688150.SS": "莱伯泰科",
  "688151.SS": "麒麟信安",
  "688152.SS": "麦格米特",
  "688153.SS": "唯捷创芯",
  "688154.SS": "华辰装备",
  "688155.SS": "莱特光电",
  "688156.SS": "路维光电",
  "688157.SS": "松井股份",
  "688158.SS": "优刻得",
  "688159.SS": "有研粉材",
  "688160.SS": "华正新材",
  "688161.SS": "华冠科技",
  "688162.SS": "巨一科技",
  "688163.SS": "汇成股份",
  "688164.SS": "海创药业",
  "688165.SS": "天际股份",
  "688166.SS": "博瑞医药",
  "688167.SS": "炬光科技",
  "688168.SS": "华秦科技",
  "688169.SS": "石头科技",
  "688170.SS": "德龙激光",
  "688171.SS": "纬德信息",
  "688172.SS": "科德数控",
  "688173.SS": "希荻微",
  "688174.SS": "云从科技",
  "688175.SS": "东微半导",
  "688176.SS": "亚虹医药",
  "688177.SS": "海天瑞声",
  "688178.SS": "万德斯",
  "688179.SS": "圣湘生物",
  "688180.SS": "君实生物",
  "688181.SS": "八方股份",
  "688182.SS": "成都先导",
  "688183.SS": "生益电子",
  "688184.SS": "帝奥微",
  "688185.SS": "康希诺",
  "688186.SS": "安必平",
  "688187.SS": "时代电气",
  "688188.SS": "柏楚电子",
  "688189.SS": "帝科股份",
  "688190.SS": "云路股份",
  "688191.SS": "智洋创新",
  "688192.SS": "迪哲医药",
  "688193.SS": "格科微",
  "688194.SS": "普蕊斯",
  "688195.SS": "腾景科技",
  "688196.SS": "卓安消防",
  "688197.SS": "聚石化学",
  "688198.SS": "佰维存储",
  "688199.SS": "久日新材",
  "688200.SS": "华峰测控",
  "688201.SS": "信安世纪",
  "688202.SS": "美迪凯",
  "688203.SS": "海正生材",
  "688204.SS": "华岭股份",
  "688205.SS": "德科立",
  "688206.SS": "概伦电子",
  "688207.SS": "申联生物",
  "688208.SS": "道通科技",
  "688209.SS": "英科医疗",
  "688210.SS": "晶丰明源",
  "688211.SS": "中科微至",
  "688212.SS": "澳华内镜",
  "688213.SS": "思特威",
  "688214.SS": "科美诊断",
  "688215.SS": "瑞晟智能",
  "688216.SS": "气派科技",
  "688217.SS": "睿昂基因",
  "688218.SS": "江苏博云",
  "688219.SS": "会通股份",
  "688220.SS": "翱捷科技",
  "688221.SS": "前沿生物",
  "688222.SS": "成都先导",
  "688223.SS": "晶科能源",
  "688224.SS": "睿创微纳",
  "688225.SS": "亚辉龙",
  "688226.SS": "威腾电气",
  "688227.SS": "品茗股份",
  "688228.SS": "开普云",
  "688229.SS": "博睿数据",
  "688230.SS": "芯导科技",
  "688231.SS": "隆达股份",
  "688232.SS": "新点软件",
  "688233.SS": "神工股份",
  "688234.SS": "天岳先进",
  "688235.SS": "百济神州",
  "688236.SS": "春立医疗",
  "688237.SS": "传音控股",
  "688238.SS": "和元生物",
  "688239.SS": "航宇科技",
  "688240.SS": "华特气体",
  "688241.SS": "峰岹科技",
  "688242.SS": "先惠技术",
  "688243.SS": "智明达",
  "688244.SS": "永信至诚",
  "688245.SS": "天地数码",
  "688246.SS": "开元股份",
  "688247.SS": "宣泰医药",
  "688248.SS": "南网科技",
  "688249.SS": "晶科能源",
  "688250.SS": "铁建重工",
  "688251.SS": "其石科技",
  "688252.SS": "天德钰",
  "688253.SS": "英诺特",
  "688254.SS": "华海诚科",
  "688255.SS": "凯尔达",
  "688256.SS": "寒武纪",
  "688257.SS": "新锐股份",
  "688258.SS": "卓然股份",
  "688259.SS": "创耀科技",
  "688260.SS": "昀冢科技",
  "688261.SS": "东芯股份",
  "688262.SS": "国芯科技",
  "688263.SS": "先锋电子",
  "688264.SS": "西部超导",
  "688265.SS": "南芯科技",
  "688266.SS": "泽璟制药",
  "688267.SS": "博拓生物",
  "688268.SS": "华特气体",
  "688269.SS": "凯立新材",
  "688270.SS": "以太股份",
  "688271.SS": "联影医疗",
  "688272.SS": "永达汽车",
  "688273.SS": "森赫股份",
  "688274.SS": "实朴检测",
  "688275.SS": "百诚医药",
  "688276.SS": "百克生物",
  "688277.SS": "天智航",
  "688278.SS": "特宝生物",
  "688279.SS": "峰岹科技",
  "688280.SS": "精进电动",
  "688281.SS": "华秦科技",
  "688282.SS": "理工导航",
  "688283.SS": "坤恒顺维",
  "688284.SS": "卓安消防",
  "688285.SS": "国芯科技",
  "688286.SS": "敏芯股份",
  "688287.SS": "观想科技",
  "688288.SS": "鸿泉物联",
  "688289.SS": "圣湘生物",
  "688290.SS": "景业智能",
  "688291.SS": "金橙子",
  "688292.SS": "浩欧博",
  "688293.SS": "奥浦迈",
  "688294.SS": "纳微科技",
  "688295.SS": "中复神鹰",
  "688296.SS": "和达科技",
  "688297.SS": "海创药业",
  "688298.SS": "东方生物",
  "688299.SS": "长远锂科",
  "688300.SS": "联博股份",
  "688301.SS": "奕瑞科技",
  "688302.SS": "海创药业",
  "688303.SS": "大全能源",
  "688304.SS": "安路科技",
  "688305.SS": "科德数控",
  "688306.SS": "均联智行",
  "688307.SS": "中润光学",
  "688308.SS": "欧科亿",
  "688309.SS": "万润新能",
  "688310.SS": "迪哲医药",
  "688311.SS": "盟固利",
  "688312.SS": "燕麦科技",
  "688313.SS": "仕净科技",
  "688314.SS": "科伦博泰",
  "688315.SS": "诺禾致源",
  "688316.SS": "青云科技",
  "688317.SS": "极米科技",
  "688318.SS": "财富趋势",
  "688319.SS": "唯赛勃",
  "688320.SS": "铂力特",
  "688321.SS": "微芯生物",
  "688322.SS": "奥动新能源",
  "688323.SS": "瑞华泰",
  "688324.SS": "普源精电",
  "688325.SS": "赛克赛斯",
  "688326.SS": "经纬恒润",
  "688327.SS": "云从科技",
  "688328.SS": "星宸科技",
  "688329.SS": "艾力斯",
  "688330.SS": "宏景科技",
  "688331.SS": "荣昌生物",
  "688332.SS": "天岳先进",
  "688333.SS": "铖昌科技",
  "688334.SS": "西高院",
  "688335.SS": "复洁环保",
  "688336.SS": "三孚新科",
  "688337.SS": "普源精电",
  "688338.SS": "赛科希德",
  "688339.SS": "亿华通",
  "688340.SS": "盟固利",
  "688341.SS": "欧林生物",
  "688342.SS": "康方生物",
  "688343.SS": "云从科技",
  "688344.SS": "华岭股份",
  "688345.SS": "博睿数据",
  "688346.SS": "百奥泰",
  "688347.SS": "华虹公司",
  "688348.SS": "昆仑万维",
  "688349.SS": "三生国健",
  "688350.SS": "富淡科技",
  "688351.SS": "微导纳米",
  "688352.SS": "展鹏科技",
  "688353.SS": "华盛锂电",
  "688354.SS": "德必集团",
  "688355.SS": "明志科技",
  "688356.SS": "键凯科技",
  "688357.SS": "建科院",
  "688358.SS": "三鑫医疗",
  "688359.SS": "东微半导",
  "688360.SS": "德马科技",
  "688361.SS": "中科飞测",
  "688362.SS": "甬矽电子",
  "688363.SS": "华熙生物",
  "688364.SS": "光庭信息",
  "688365.SS": "光华科技",
  "688366.SS": "昊海生科",
  "688367.SS": "工大高科",
  "688368.SS": "晶丰明源",
  "688369.SS": "致远互联",
  "688370.SS": "丽人丽妆",
  "688371.SS": "中科蓝讯",
  "688372.SS": "伟测科技",
  "688373.SS": "盟固利",
  "688374.SS": "浩欧博",
  "688375.SS": "国博电子",
  "688376.SS": "美埃科技",
  "688377.SS": "迪威迅",
  "688378.SS": "奥浦迈",
  "688379.SS": "华光新材",
  "688380.SS": "安邦护卫",
  "688381.SS": "上海谊众",
  "688382.SS": "益方生物",
  "688383.SS": "新诺威",
  "688384.SS": "元琛科技",
  "688385.SS": "复旦微电",
  "688386.SS": "泛亚微透",
  "688387.SS": "信科移动",
  "688388.SS": "嘉元科技",
  "688389.SS": "普蕊斯",
  "688390.SS": "固德威",
  "688391.SS": "钜泉科技",
  "688392.SS": "中科蓝讯",
  "688393.SS": "安必平",
  "688394.SS": "普蕊斯",
  "688395.SS": "正弦电气",
  "688396.SS": "华润微",
  "688397.SS": "振华新材",
  "688398.SS": "赛特新材",
  "688399.SS": "硕世生物",
  "688400.SS": "芯导科技",
  "688401.SS": "路维光电",
  "688402.SS": "思特威",
  "688403.SS": "汇成股份",
  "688404.SS": "百济神州",
  "688405.SS": "科德数控",
  "688406.SS": "博瑞医药",
  "688407.SS": "中科海钠",
  "688408.SS": "中信博",
  "688409.SS": "富淡科技",
  "688410.SS": "山外山",
  "688411.SS": "正弦电气",
  "688412.SS": "伟思医疗",
  "688413.SS": "奥精医疗",
  "688414.SS": "中科蓝讯",
  "688415.SS": "乐鑫科技",
  "688416.SS": "恒烁股份",
  "688417.SS": "汇宇制药",
  "688418.SS": "震裕科技",
  "688419.SS": "耐科装备",
  "688420.SS": "科德数控",
  "688421.SS": "英诺特",
  "688422.SS": "芯动联科",
  "688423.SS": "铁建重工",
  "688424.SS": "富信科技",
  "688425.SS": "铁建重工",
  "688426.SS": "康方生物",
  "688427.SS": "赛诺医疗",
  "688428.SS": "诺唯赞",
  "688429.SS": "时代电气",
  "688430.SS": "科德数控",
  "688431.SS": "荣昌生物",
  "688432.SS": "大地熊",
  "688433.SS": "华虹公司",
  "688434.SS": "格科微",
  "688435.SS": "中芯国际",
  "688436.SS": "寒武纪",
  "688437.SS": "沪硅产业",
  "688438.SS": "中微公司",
  "688439.SS": "澜起科技",
  "688440.SS": "石头科技",
  "688441.SS": "柏楚电子",
  "688442.SS": "汇川技术",
  "688443.SS": "华海清科",
  "688444.SS": "拓荆科技",
  "688445.SS": "西部超导",
  "688446.SS": "盛美上海",
  "688447.SS": "微导纳米",
  "688448.SS": "极米科技",
  "688449.SS": "联影医疗",
  "688450.SS": "纳芯微",
  "688451.SS": "翱捷科技",
  "688452.SS": "纳微科技",
  "688453.SS": "中复神鹰",
  "688454.SS": "大全能源",
  "688455.SS": "晶科能源",
  "688456.SS": "天岳先进",
  "688457.SS": "铂力特",
  "688458.SS": "亿华通",
  "688459.SS": "华熙生物",
  "688460.SS": "华润微",
  "688461.SS": "华虹公司",
  "688462.SS": "百济神州",
  "688463.SS": "荣昌生物",
  "688464.SS": "康方生物",
  "688465.SS": "艾力斯",
  "688466.SS": "昊海生科",
  "688467.SS": "君实生物",
  "688468.SS": "三生国健",
  "688469.SS": "百奥泰",
  "688470.SS": "泽璟制药",
  "688471.SS": "前沿生物",
  "688472.SS": "亚虹医药",
  "688473.SS": "迪哲医药",
  "688474.SS": "益方生物",
  "688475.SS": "海创药业",
  "688476.SS": "科伦博泰",
  "688477.SS": "诺禾致源",
  "688478.SS": "和元生物",
  "688479.SS": "奥浦迈",
  "688480.SS": "博睿数据",
  "688481.SS": "普蕊斯",
  "688482.SS": "安必平",
  "688483.SS": "英诺特",
  "688484.SS": "圣湘生物",
  "688485.SS": "东方生物",
  "688486.SS": "宣泰医药",
  "688487.SS": "百诚医药",
  "688488.SS": "百克生物",
  "688489.SS": "特宝生物",
  "688490.SS": "博拓生物",
  "688491.SS": "欧林生物",
  "688492.SS": "申联生物",
  "688493.SS": "凯赛生物",
  "688494.SS": "成都先导",
  "688495.SS": "皓元医药",
  "688496.SS": "毕得医药",
  "688497.SS": "泰坦科技",
  "688498.SS": "奥精医疗",
  "688499.SS": "三鑫医疗",
  "688500.SS": "伟思医疗",
  "688501.SS": "天智航",
  "688502.SS": "澳华内镜",
  "688503.SS": "南微医学",
  "688504.SS": "爱博医疗",
  "688505.SS": "心脉医疗",
  "688506.SS": "春立医疗",
  "688507.SS": "健帆生物",
  "688508.SS": "乐普医疗",
  "688509.SS": "迈瑞医疗",
  "688510.SS": "联影医疗",
  "688511.SS": "华大智造",
  "688512.SS": "华大基因",
  "688513.SS": "诺唯赞",
  "688514.SS": "亚辉龙",
  "688515.SS": "科美诊断",
  "688516.SS": "奥浦迈",
  "688517.SS": "药康生物",
  "688518.SS": "近岸蛋白",
  "688519.SS": "海正生材",
  "688520.SS": "芳源股份",
  "688521.SS": "芯动联科",
  "688522.SS": "芯碁微装",
  "688523.SS": "中科飞测",
  "688524.SS": "盟固利",
  "688525.SS": "奕瑞科技",
  "688526.SS": "科德数控",
  "688527.SS": "铂力特",
  "688528.SS": "秦川机床",
  "688529.SS": "博众精工",
  "688530.SS": "微导纳米",
  "688531.SS": "华海清科",
  "688532.SS": "拓荆科技",
  "688533.SS": "盛美上海",
  "688534.SS": "西部超导",
  "688535.SS": "中复神鹰",
  "688536.SS": "思特威",
  "688537.SS": "格科微",
  "688538.SS": "澜起科技",
  "688539.SS": "中微公司",
  "688540.SS": "中芯国际",
  "688541.SS": "沪硅产业",
  "688542.SS": "华润微",
  "688543.SS": "华虹公司",
  "688544.SS": "翱捷科技",
  "688545.SS": "纳芯微",
  "688546.SS": "寒武纪",
  "688547.SS": "柏楚电子",
  "688548.SS": "石头科技",
  "688549.SS": "极米科技",
  "688550.SS": "联影医疗",
  "688551.SS": "大全能源",
  "688552.SS": "晶科能源",
  "688553.SS": "天岳先进",
  "688554.SS": "亿华通",
  "688555.SS": "华熙生物",
  "688556.SS": "百济神州",
  "688557.SS": "荣昌生物",
  "688558.SS": "康方生物",
  "688559.SS": "艾力斯",
  "688560.SS": "纳微科技",
  "688561.SS": "奥精医疗",
  "688562.SS": "三鑫医疗",
  "688563.SS": "伟思医疗",
  "688564.SS": "天智航",
  "688565.SS": "澳华内镜",
  "688566.SS": "南微医学",
  "688567.SS": "爱博医疗",
  "688568.SS": "心脉医疗",
  "688569.SS": "春立医疗",
  "688570.SS": "健帆生物",
  "688571.SS": "乐普医疗",
  "688572.SS": "迈瑞医疗",
  "688573.SS": "华大智造",
  "688574.SS": "华大基因",
  "688575.SS": "诺唯赞",
  "688576.SS": "亚辉龙",
  "688577.SS": "科美诊断",
  "688578.SS": "药康生物",
  "688579.SS": "近岸蛋白",
  "688580.SS": "海正生材",
  "688581.SS": "芳源股份",
  "688582.SS": "芯动联科",
  "688583.SS": "芯碁微装",
  "688584.SS": "中科飞测",
  "688585.SS": "盟固利",
  "688586.SS": "奕瑞科技",
  "688587.SS": "科德数控",
  "688588.SS": "铂力特",
  "688589.SS": "博众精工",
  "688590.SS": "微导纳米",
  "688591.SS": "华海清科",
  "688592.SS": "拓荆科技",
  "688593.SS": "盛美上海",
  "688594.SS": "西部超导",
  "688595.SS": "中复神鹰",
  "688596.SS": "思特威",
  "688597.SS": "格科微",
  "688598.SS": "澜起科技",
  "688599.SS": "中微公司",
  "688600.SS": "中芯国际",
  "688601.SS": "沪硅产业",
  "688602.SS": "华润微",
  "688603.SS": "华虹公司",
  "688604.SS": "翱捷科技",
  "688605.SS": "纳芯微",
  "688606.SS": "寒武纪",
  "688607.SS": "柏楚电子",
  "688608.SS": "石头科技",
  "688609.SS": "极米科技",
  "688610.SS": "联影医疗",
};

// ============================================================
// 服务端代理 Yahoo Finance API
// ============================================================

const YAHOO_BASE = "https://query1.finance.yahoo.com";
const HEADERS = {
  "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
  "Accept": "application/json",
};

async function yahooFetch(path: string): Promise<unknown> {
  const res = await fetch(`${YAHOO_BASE}${path}`, { headers: HEADERS });
  if (!res.ok) {
    throw new TRPCError({
      code: "BAD_GATEWAY",
      message: `Yahoo Finance 请求失败: ${res.status}`,
    });
  }
  return res.json();
}

/**
 * 获取股票名称（优先使用本地映射，否则使用 Yahoo Finance 返回的名称）
 */
export function getStockDisplayName(symbol: string, longName?: string, shortName?: string): string {
  const upperSymbol = symbol.toUpperCase();
  if (A_STOCK_NAMES[upperSymbol]) {
    return A_STOCK_NAMES[upperSymbol];
  }
  return longName || shortName || symbol;
}

export const stockRouter = router({
  /**
   * 获取股票 K 线图数据（服务端代理）
   */
  chart: publicProcedure
    .input(z.object({
      symbol: z.string().min(1).max(20),
      range: z.enum(["1d", "5d", "1mo", "3mo", "6mo", "1y", "2y", "5y"]).default("3mo"),
    }))
    .query(async ({ input }) => {
      const { symbol, range } = input;
      const intervalMap: Record<string, string> = {
        "1d": "5m", "5d": "15m", "1mo": "1d", "3mo": "1d",
        "6mo": "1d", "1y": "1d", "2y": "1wk", "5y": "1wk",
      };
      const interval = intervalMap[range];
      const region = /\.(SS|SZ)$/i.test(symbol) ? "CN" : "US";

      const data = await yahooFetch(
        `/v8/finance/chart/${encodeURIComponent(symbol)}?interval=${interval}&range=${range}&region=${region}&includeAdjustedClose=true`
      ) as any;

      if (!data?.chart?.result?.[0]) {
        throw new TRPCError({ code: "NOT_FOUND", message: "未找到该股票数据" });
      }

      const result = data.chart.result[0];
      const meta = result.meta;
      const timestamps: number[] = result.timestamp || [];
      const quotes = result.indicators?.quote?.[0] || {};

      const candles = [];
      for (let i = 0; i < timestamps.length; i++) {
        const open = quotes.open?.[i];
        const high = quotes.high?.[i];
        const low = quotes.low?.[i];
        const close = quotes.close?.[i];
        const volume = quotes.volume?.[i];
        if (open != null && high != null && low != null && close != null) {
          candles.push({ time: timestamps[i], open, high, low, close, volume: volume ?? 0 });
        }
      }

      const prevClose = meta.previousClose ?? meta.chartPreviousClose ?? meta.regularMarketPrice;
      const change = meta.regularMarketPrice - prevClose;
      const changePercent = prevClose > 0 ? (change / prevClose) * 100 : 0;

      return {
        meta: {
          symbol: meta.symbol,
          displayName: getStockDisplayName(symbol, meta.longName, meta.shortName),
          longName: meta.longName,
          shortName: meta.shortName,
          currency: meta.currency,
          exchangeName: meta.exchangeName,
          regularMarketPrice: meta.regularMarketPrice,
          regularMarketChange: change,
          regularMarketChangePercent: changePercent,
          regularMarketDayHigh: meta.regularMarketDayHigh,
          regularMarketDayLow: meta.regularMarketDayLow,
          regularMarketVolume: meta.regularMarketVolume,
          regularMarketOpen: meta.regularMarketOpen ?? meta.regularMarketPrice,
          previousClose: prevClose,
          fiftyTwoWeekHigh: meta.fiftyTwoWeekHigh,
          fiftyTwoWeekLow: meta.fiftyTwoWeekLow,
          marketCap: meta.marketCap,
          trailingPE: meta.trailingPE,
        },
        candles,
      };
    }),

  /**
   * 搜索股票（服务端代理）
   */
  search: publicProcedure
    .input(z.object({ query: z.string().min(1).max(50) }))
    .query(async ({ input }) => {
      const data = await yahooFetch(
        `/v1/finance/search?q=${encodeURIComponent(input.query)}&lang=zh-CN&region=CN&quotesCount=10&newsCount=0`
      ) as any;

      const quotes = (data?.quotes || []) as Array<{
        symbol: string;
        longname?: string;
        shortname?: string;
        exchDisp?: string;
        typeDisp?: string;
      }>;

      return quotes.map(q => ({
        symbol: q.symbol,
        displayName: getStockDisplayName(q.symbol, q.longname, q.shortname),
        longName: q.longname,
        shortName: q.shortname,
        exchange: q.exchDisp,
        type: q.typeDisp,
      }));
    }),

  /**
   * 获取多只股票的实时报价
   */
  quotes: publicProcedure
    .input(z.object({ symbols: z.array(z.string()).min(1).max(20) }))
    .query(async ({ input }) => {
      const symbolStr = input.symbols.join(",");
      const data = await yahooFetch(
        `/v7/finance/quote?symbols=${encodeURIComponent(symbolStr)}&lang=zh-CN&region=CN`
      ) as any;

      const results = data?.quoteResponse?.result || [];
      return results.map((q: any) => ({
        symbol: q.symbol,
        displayName: getStockDisplayName(q.symbol, q.longName, q.shortName),
        longName: q.longName,
        shortName: q.shortName,
        regularMarketPrice: q.regularMarketPrice,
        regularMarketChange: q.regularMarketChange,
        regularMarketChangePercent: q.regularMarketChangePercent,
        currency: q.currency,
        exchangeName: q.fullExchangeName,
        marketCap: q.marketCap,
        trailingPE: q.trailingPE,
      }));
    }),
});
